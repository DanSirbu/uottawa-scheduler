<!DOCTYPE html>
<html lang="en">
<head>
    <!--
Schedule Variant
Year Select
-->
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        th.blank_space {
            width: 1rem;
            border-top: 0;
        }

        td.blank_space {
            width: 1rem;
            border-top: 0;
        }

        th {
            text-align: left;
        }

        td {
            text-align: left;
        }

        .monitored_table tbody tr:hover {
            background-color: #F5F5F5;
            cursor: pointer;
        }

        .monitored_table {
            margin-left: 0.5rem;
            table-layout:fixed;
        }
        #courseListTable .courseTitle {
            border: 1px solid #dbdbdb;
            border-width: 0 0 1px;
            padding: .5em .75em;
            vertical-align: top;
        }
        body.modal-open { overflow: hidden; }
    </style>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-102626620-1', 'auto');
        ga('send', 'pageview');

    </script>

    <script
            src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script> <!-- jquery 3.xx breaks the radio button deselect below, find out why -->

    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.4/js.cookie.min.js" integrity="sha256-NjbogQqosWgor0UBdCURR5dzcvAgHnfUZMcZ8RCwkk8=" crossorigin="anonymous"></script>

    <script src="blob.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js" integrity="sha256-FPJJt8nA+xL4RU6/gsriA8p8xAeLGatoyTjldvQKGdE=" crossorigin="anonymous"></script>
    <script src="icsFormatter.js"></script>
    <script src="utilities.js"></script>
    <script src="course.titles.min.js"></script><!-- Used for autocomplete search -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.4.3/css/bulma.min.css">
    <!-- Css Framework -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.min.css"
          integrity="sha256-TQcHzEz3/ZJ8MeAoO1SRE5sa5q68U57dwZO/tArtNqk=" crossorigin="anonymous"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.2/awesomplete.min.js"
            integrity="sha256-xA+USAVmEnBnz1FiLRSG8xglJflQVHmQvbx5+u4bslk=" crossorigin="anonymous"></script>


    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.css'/>
    <link rel="stylesheet" href="css/fontello/fontello.css">

    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js'></script>
    <script src="schedule_generator.js"></script>
    <style>
        .fc-event {
            margin-bottom: 1px;
        }
        .eventPlace, .eventProf {
            font-size: 0.9em;
        }
        .table-spacer {
            height: 1rem;
        }
    </style>
    <!-- <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script> -->
    <script>
        var dayStrings = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

        var template_activity = `
            <tr>
            <td>
            {{ActivityType}}
        </td>
        <td>
        {{Name}}
        </td>
        <td>
        {{Place}}
        </td>
        <td>
        {{Professor}}
        </td>
        <td>
        {{Day}} {{StartHour}} - {{EndHour}}
        </td>
            </tr>`;

        var courseList = [];
        var selectedScheduleVariantIndex = 0;
        var topGeneratedActivities = [];
        var currentYear = new Date().getFullYear();//TODO update to actual selected year
        var currentSemester = 0;//TODO 0 Fall, 1 Winter
        var appVersion = 1;

        //Allow radio buttons to be deselectable
        $(function () {
            var inputClickHandler = function () {
                var previousValue = $(this).attr('previousValue');
                var name = $(this).attr('name');

                if (previousValue == 'checked') {
                    $(this).prop('checked', false);
                    $(this).attr('previousValue', false);
                    $(this).checkboxradio("refresh");//This method doesn't exist but it works for some reason (any non-existent method will refresh the view)
                }
                else {
                    $("input[name=" + name + "]:radio").attr('previousValue', false);
                    $(this).attr('previousValue', 'checked');
                }
            };

            /*
             $('.record_table tr').click(function (event) {
             if (event.target.type !== 'checkbox') {
             $(':checkbox', this).trigger('click');
             }
             });
             */

            $("input[type='radio']").click(inputClickHandler);

            $('.monitored_table tbody tr').click(function (event) {
                if (event.target.type !== 'radio') {
                    $(':radio', this).trigger("click");
                }
            });

            $('#courseListTable').on('click', '.removeCourseBtn', function () {
                var courseCode = $(this).parent().parent().parent().attr('data-course-code');
                removeCourse(courseCode);
            });

            new Awesomplete($('#courseSearch')[0], {
                list: coursesTitle
            });

            document.getElementById("courseSearch").addEventListener('awesomplete-selectcomplete', function (e) {
                var courseCode = e.text.label.split(" ")[0];
                getCourseAndAddIt(courseCode);
                this.value = "";
            });

        });

        function getCourseAndAddIt(courseCode) {
            //If already added the course, then return
            if (courseList.filter(function (e) {
                    return e.CourseCode == courseCode;
                }).length > 0) return;

            var path = "./courses/" + courseCode + ".json";
            $.getJSON(path, addCourse);
        }
        function addCourse(course) {
            courseList.push(course);
            updateCookiesAsync();

            var courseHtml = generateCourseHTML(course);
            $('#courseListTable').append(courseHtml);

            //Update Agenda
            generateAndShowSchedules();
        }
        function removeCourse(courseCode) {
            courseList = courseList.filter(function (course) {//Remove course from courselist
                return course.CourseCode != courseCode;
            });
            updateCookiesAsync();

            //Update View
            $("#courseListTable tbody[data-course-code=" + courseCode + "]").remove();

            //Update Agenda
            generateAndShowSchedules();
        }
        
        function updateCookiesAsync() {
            console.log('Updated Cookies');
            setTimeout(updateCookies, 0);
            function updateCookies() {
                Cookies.set('version', appVersion);
                Cookies.set('courses', courseList);
                Cookies.set('scheduleVariantIndex', selectedScheduleVariantIndex);
            }
        }

        function generateCourseHTML(course) {
            var courseHtml = "<tbody data-course-code='{{CourseCode}}'><tr><th class='courseTitle' colspan='2'>{{CourseCode}} {{CourseName}} <a class='removeCourseBtn'><span class='icon is-small'><i class='icon-cancel'></i></span></a> </th></tr><td><table class='monitored_table table'>"
                .replaceAll("{{CourseCode}}", course.CourseCode)
                .replace("{{CourseName}}", course.Title);

            course.Sections.forEach(function (courseSection) {
                //For Each Section Code (A, B, C)
                var sectionCode = courseSection.SectionCode;
                var sectionHtml = "<thead><tr><th>Section {{SectionCode}}</th></tr></thead>".replace("{{SectionCode}}", sectionCode);

                //TODO Sort By LEC, DGD, ETC
                courseSection.ActivityGroups.forEach(function (activityGroup) {
                    sectionHtml += "<tbody>";
                    activityGroup.Activities.forEach(function (activity) {
                        sectionHtml += generateActivityHtml(activity, sectionCode);
                    });
                    sectionHtml += "</tbody>";
                });

                courseHtml += sectionHtml;
            });

            courseHtml += "</table></td>";
            courseHtml += "<tr class='table-spacer'></tr>";
            courseHtml += "</tbody>";

            return courseHtml;
        }

        function generateActivityHtml(activity, sectionCode) {
            var result = template_activity.replace("{{ActivityType}}", activity.ActivityType)
                .replaceAll("{{Name}}", activity.Name)
                .replace("{{Day}}", dayStrings[activity.Day])
                .replace("{{StartHour}}", convertHourMinuteIntegerToString(activity.StartHour))
                .replace("{{EndHour}}", convertHourMinuteIntegerToString(activity.EndHour))
                .replace("{{Place}}", activity.Place)
                .replace("{{Professor}}", activity.Professor)
                .replace("{{SectionName}}", "section_" + sectionCode + activity.ActivityType);

            return result;
        }
    </script>

    <script>
        var calendarSettings = {
            header: false,
            defaultView: 'agendaWeek',
            allDaySlot: false,
            editable: false,
            height: 'auto',
            eventRender: function (event, element, view) {
                var title = element.find('.fc-title');
                title.html(title.text());
            },
            eventClick: function(calEvent, jsEvent, view) {

                //alert('Event: ' + calEvent.title);
                //alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
                //alert('View: ' + view.name);

                var start = moment(calEvent.start).format("hh:mm");
                var end = moment(calEvent.end).format("hh:mm");
                var modalHtml = start + " - " + end + "<br/>" + calEvent.title;

                var eventClickView = $('#eventClickView');
                eventClickView.find(".modal-content-html").html(modalHtml);
                eventClickView.addClass('is-active');

                eventClickView.find('.modal-close').click(closeModal);
                eventClickView.click(function (e) {
                    if(!$(e.target).hasClass('box')) {
                        closeModal();
                    }
                });

                function closeModal() {
                    $('#eventClickView').removeClass('is-active');
                }
            }
        };

        $(function () {
            $('#radioNumActivityComb input').on('change', function () {
                var selectedIndex = parseInt($('#radioNumActivityComb input[name=scheduleIndex]:checked').val());
                selectScheduleVariant(selectedIndex);
            });
            showNumSelectableActivities(0); //Disable all radio buttons

            $("#calendar").fullCalendar(calendarSettings);
            removeDateInDayHeader();
        });

        function removeDateInDayHeader() {//Could not find option to disable this in fullcalendar
            $('.fc-day-header span').each(function (index, element) {
                element.textContent = element.textContent.split(" ")[0]; //Converts "Mon 23" to Mon
            });
        }

        function pickTopGeneratedActivities(generatedActivitiesCombinations) {
            if (generatedActivitiesCombinations.length < 5) {
                return toArray(generatedActivitiesCombinations);
            }

            //TODO
            //Pick top 5 activity comb
            return generatedActivitiesCombinations.slice(0, 4);
        }
        function showNumSelectableActivities(activitiesLength) {
            $('#radioNumActivityComb input[type="radio"]').each(function (index, radioBtn) {
                $(radioBtn).prop("disabled", parseInt(radioBtn.value) >= activitiesLength);
            });
        }
        function clearSelectedActivityIndex() {
            $('#radioNumActivityComb').find('input[name="scheduleIndex"]').prop('checked', false);
        }
        function generateAndShowSchedules() {
            if(courseList.length == 0) {
                clearError();
                return
            }

            var generatedActivitiesComb = generateValidSchedulesFromCourses(courseList);
            console.log("Generated %s activities", generatedActivitiesComb.length);

            topGeneratedActivities = pickTopGeneratedActivities(generatedActivitiesComb);
            showNumSelectableActivities(topGeneratedActivities.length);
            clearSelectedActivityIndex();

            if (topGeneratedActivities.length == 0) {
                showError("No combination is possible. Remove 1 or more courses.")
            }
            else {
                selectScheduleVariant(0);
                clearError();
            }
        }
        function showError(message) {
            $('#errorMessage').html("&nbsp;" + message);
            $('#errorMessage').show();
        }
        function clearError() {
            $('#errorMessage').hide();
        }

        function selectScheduleVariant(index) {
            var activities = toArray(topGeneratedActivities[index]);
            selectedScheduleVariantIndex = index;
            updateCookiesAsync();

            var fullCalendarActivities = [];

            activities.forEach(function (activity) {
                fullCalendarActivities.push(convertActivityToFullCalendarFormat(activity));
            });

            //Change Selected Schedule #
            clearSelectedActivityIndex();
            $('#radioNumActivityComb input[name="scheduleIndex"][value="' + index + '"]').prop('checked', true);


            $("#calendar").fullCalendar('removeEvents');
            $("#calendar").fullCalendar('renderEvents', fullCalendarActivities);
        }
        function convertActivityToFullCalendarFormat(activity) {
            var courseCode = activity.Name.split(" ")[0];
            var salt = " -ASDASDG";//Helps avoid color collision

            var activityColor = nameToColor(courseCode + salt);
            var eventDay = (activity.Day + 1) % 7; //Monday is index 0 in our data and fullCalendar wants Sunday to be index 0
            var event = {
                title: activity.Name + " (" + activity.ActivityType + ")" + "<br /><span class='eventPlace'>" + activity.Place + "</span><br /><span class='eventProf'>" + activity.Professor + "</span>",
                color: activityColor,
                start: convertHourMinuteIntegerToString(activity.StartHour),
                end: convertHourMinuteIntegerToString(activity.EndHour),
                dow: [eventDay],
                allDay: false
            }

            return event;
        }
    </script>
    <script>
        Cookies.defaults.expires = 14;
        setTimeout(loadCookies, 0);
        function loadCookies() {
            var cookiesVersion = Cookies.get('version');
            if(appVersion > cookiesVersion) {
                return //Don't parse if cookies are old version
            }

            var courses = Cookies.getJSON('courses');
            var scheduleVariantIndex = Cookies.get('scheduleVariantIndex');

            courses.forEach(function (course) {
                addCourse(course);
            });
            selectScheduleVariant(scheduleVariantIndex);
        }
    </script>
    <script>
        $(function () {
           $('#downloadSchedule').click(function () {
               downloadSchedule();
               return false; //Prevent link from doing anything
           });
        });
        function convertActivityToICSFormat(activity) {
            var dayStrings = ['MO', 'TU', 'WE', 'TH', 'FR', 'SA', 'SU'];


            //Convert to Format 2017-07-18T20:04:03Z
            function toISODateFormat(year, monthHour, hourMinute) {
                return year + "-" + monthHour + "T" + convertHourMinuteIntegerToString(hourMinute) + ":00Z";
            }

            var startHourDate = moment(toISODateFormat(currentYear, activity.StartDate, activity.StartHour));
            var endHourDate = moment(toISODateFormat(currentYear, activity.StartDate, activity.EndHour));
            var numDaysToAdd = getNumDaysToDayOfWeek(startHourDate.isoWeekday() - 1, activity.Day);
            startHourDate.add(numDaysToAdd, 'days');
            endHourDate.add(numDaysToAdd, 'days');

            var untilDate = currentYear + "-" + activity.EndDate;
            var recurrentDay = dayStrings[activity.Day];

            return {
                title: activity.Name,
                description: activity.ActivityType + "\r\n" + activity.Professor,
                location: activity.Place,
                startDate: startHourDate.toISOString(),
                endDate: endHourDate.toISOString(),
                rrule: {
                    freq: 'WEEKLY',
                    until: untilDate,
                    byday: [recurrentDay]
                }
            };

            //Both are Monday Indexed
            //Get the number of days to add(can be 0) so we get the expectedDayOfWeek
            function getNumDaysToDayOfWeek(currentDayOfWeek, expectedDayOfWeek) {
                return (expectedDayOfWeek - currentDayOfWeek + 7) % 7;
            }
        }
        function downloadSchedule() {
            var activities = topGeneratedActivities[selectedScheduleVariantIndex];

            var cal = ics("uottawa-scheduler");

            activities.forEach(function (activity) {
                var calEvent = convertActivityToICSFormat(activity);

                try {
                    cal.addEvent(calEvent.title, calEvent.description, calEvent.location, calEvent.startDate, calEvent.endDate, calEvent.rrule);
                }catch (e) {
                    if(e.length > 0) throw e;
                }
            });

            cal.download("uottawa-scheduler", ".ics");
        }

    </script>
</head>
<body>
<div class="modal" id="eventClickView">
    <div class="modal-background"></div>
    <div class="modal-content">
        <div class="box modal-content-html">

        </div>
    </div>
    <button class="modal-close is-large"></button>
</div>

<nav class="navbar ">
    <div class="navbar-brand">
        <a class="navbar-item" href="http://bulma.io">
            <img src="http://bulma.io/images/bulma-logo.png" alt="Bulma: a modern CSS framework based on Flexbox" width="112" height="28">
        </a>

        <a class="navbar-item is-hidden-desktop" href="https://github.com/dansirbu" target="_blank">
      <span class="icon" style="color: #333;">
        <i class="fa fa-github"></i>
      </span>
        </a>

        <a class="navbar-item is-hidden-desktop" href="https://twitter.com/jgthms" target="_blank">
      <span class="icon" style="color: #55acee;">
        <i class="fa fa-twitter"></i>
      </span>
        </a>

        <div class="navbar-burger burger" data-target="navMenuExample">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div id="navMenuExample" class="navbar-menu">
        <div class="navbar-start">
            <a class="navbar-item " href="http://bulma.io/">
                Home
            </a>
            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link  is-active" href="/documentation/overview/start/">
                    Docs
                </a>
                <div class="navbar-dropdown ">
                    <a class="navbar-item " href="/documentation/overview/start/">
                        Overview
                    </a>
                    <a class="navbar-item " href="http://bulma.io/documentation/modifiers/syntax/">
                        Modifiers
                    </a>
                    <a class="navbar-item " href="http://bulma.io/documentation/grid/columns/">
                        Grid
                    </a>
                    <a class="navbar-item " href="http://bulma.io/documentation/elements/box/">
                        Elements
                    </a>

                    <a class="navbar-item is-active" href="http://bulma.io/documentation/components/breadcrumb/">
                        Components
                    </a>

                    <a class="navbar-item " href="http://bulma.io/documentation/layout/container/">
                        Layout
                    </a>
                    <hr class="navbar-divider">
                    <div class="navbar-item">
                        <div>version <p class="has-text-info">0.4.3</p></div>
                    </div>
                </div>
            </div>
            <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link " href="http://bulma.io/blog/">
                    Blog
                </a>
                <div id="blogDropdown" class="navbar-dropdown " data-style="width: 18rem;">

                    <a class="navbar-item" href="/2017/03/10/new-field-element/">
                        <div class="navbar-content">
                            <p>
                                <small class="has-text-info">10 Mar 2017</small>
                            </p>
                            <p>New field element (for better controls)</p>
                        </div>
                    </a>

                    <a class="navbar-item" href="/2016/04/11/metro-ui-css-grid-with-bulma-tiles/">
                        <div class="navbar-content">
                            <p>
                                <small class="has-text-info">11 Apr 2016</small>
                            </p>
                            <p>Metro UI CSS grid with Bulma tiles</p>
                        </div>
                    </a>

                    <a class="navbar-item" href="/2016/02/09/blog-launched-new-responsive-columns-new-helpers/">
                        <div class="navbar-content">
                            <p>
                                <small class="has-text-info">09 Feb 2016</small>
                            </p>
                            <p>Blog launched, new responsive columns, new helpers</p>
                        </div>
                    </a>

                    <a class="navbar-item" href="http://bulma.io/blog/">
                        More posts
                    </a>
                    <hr class="navbar-divider">
                    <div class="navbar-item">
                        <div class="navbar-content">
                            <div class="level is-mobile">
                                <div class="level-left">
                                    <div class="level-item">
                                        <strong>Stay up to date!</strong>
                                    </div>
                                </div>
                                <div class="level-right">
                                    <div class="level-item">
                                        <a class="button is-rss is-small" href="http://bulma.io/atom.xml">
                      <span class="icon is-small">
                        <i class="fa fa-rss"></i>
                      </span>
                                            <span>Subscribe</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navbar-end">
            <a class="navbar-item" href="https://github.com/jgthms/bulma" target="_blank">
                Github
            </a>
            <a class="navbar-item" href="https://twitter.com/jgthms" target="_blank">
                Twitter
            </a>
            <div class="navbar-item">
                <div class="field is-grouped">
                    <p class="control">
                        <a id="twitter"
                           class="button"
                           data-social-network="Twitter"
                           data-social-action="tweet"
                           data-social-target="http://bulma.io"
                           target="_blank"
                           href="https://twitter.com/intent/tweet?text=Bulma: a modern CSS framework based on Flexbox&url=http://bulma.io&via=jgthms">
              <span class="icon">
                <i class="fa fa-twitter"></i>
              </span>
                            <span>Tweet</span>
                        </a>
                    </p>
                    <p class="control">
                        <a class="button is-primary" href="https://github.com/jgthms/bulma/archive/0.4.3.zip">
              <span class="icon">
                <i class="fa fa-download"></i>
              </span>
                            <span>Download</span>
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</nav>

<section class="section">
    <div class="container">
        <h1 class="title has-text-centered">Generate your University Of Ottawa schedule easily. Start by adding <a href="#courseListAdd">courses</a></h1>
    </div>
</section>

<section class="section">
    <div class="container" id="schedule">
        <div id="calendar"></div>

        <p>Schedule Version: </p>
        <div id="radioNumActivityComb">
            <input type="radio" name="scheduleIndex" value="0">
            <input type="radio" name="scheduleIndex" value="1">
            <input type="radio" name="scheduleIndex" value="2">
            <input type="radio" name="scheduleIndex" value="3">
            <input type="radio" name="scheduleIndex" value="4">
        </div>
        <a href="" id="downloadSchedule">Download Schedule</a>
    </div>
</section>

<section class="section">
    <div class="container">

        <nav class="panel" id="courseListAdd">
            <p class="panel-heading">
                Add To <a href="#schedule">Schedule</a>
            </p>
            <div class="panel-block">
                <p class="control has-icons-left">
                    <input id="courseSearch" class="input is-flat" type="text" placeholder="Search Course">
                    <span class="icon is-small is-left">
                        <i class="fa fa-search"></i>
                    </span>
                </p>
            </div>

            <div class="panel-block" style="border-bottom: none; border-top: none;">
                <span class="tag is-danger is-medium icon-attention" id="errorMessage" style="display: none"></span>
            </div>
            <div class="panel-block">
                <!-- Where The User can pick his/her courses -->
                <table id="courseListTable"></table>
            </div>
        </nav>

    </div>
</section>

</body>
</html>